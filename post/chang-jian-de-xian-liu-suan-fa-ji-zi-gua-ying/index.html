<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å¸¸è§çš„é™æµç®—æ³•åŠè‡ªé€‚åº” | ä»Šå¤©å­¦ä¹ äº†æ²¡</title>
<link rel="shortcut icon" href="https://mzhtech.github.io/favicon.ico?v=1731655632816">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://mzhtech.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="å¸¸è§çš„é™æµç®—æ³•åŠè‡ªé€‚åº” | ä»Šå¤©å­¦ä¹ äº†æ²¡ - Atom Feed" href="https://mzhtech.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="å‰è¨€
åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚æœæŸä¸ªæœåŠ¡èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæˆ–è€…ç½‘ç»œå‘ç”Ÿå¼‚å¸¸ï¼Œéƒ½æœ‰å¯èƒ½å¯¼è‡´è°ƒç”¨æ–¹è¢«é˜»å¡ç­‰å¾…ã€‚å¦‚æœè¶…æ—¶æ—¶é—´è®¾ç½®å¾ˆé•¿ï¼Œè°ƒç”¨æ–¹èµ„æºå¾ˆå¯èƒ½è¢«è€—å°½ã€‚è¿™åˆå¯¼è‡´äº†è°ƒç”¨æ–¹çš„ä¸Šæ¸¸ç³»ç»Ÿå‘ç”Ÿèµ„æºè€—å°½çš„æƒ…å†µï¼Œæœ€ç»ˆå¯¼è‡´ç³»ç»Ÿé›ªå´©ã€‚
è¦é˜²æ­¢ç³»ç»Ÿå‘ç”Ÿé›ªå´©ï¼Œå°±å¿…é¡»è¦æœ‰å®¹é”™..." />
    <meta name="keywords" content="ç¨³å®šæ€§,Golang" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://mzhtech.github.io">
  <img class="avatar" src="https://mzhtech.github.io/images/avatar.png?v=1731655632816" alt="">
  </a>
  <h1 class="site-title">
    ä»Šå¤©å­¦ä¹ äº†æ²¡
  </h1>
  <p class="site-description">
    å¸Œæœ›æ¯å¤©éƒ½æœ‰æ”¶è·
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              å¸¸è§çš„é™æµç®—æ³•åŠè‡ªé€‚åº”
            </h2>
            <div class="post-info">
              <span>
                2024-09-25
              </span>
              <span>
                27 min read
              </span>
              
                <a href="https://mzhtech.github.io/tag/cJNTpH2hL/" class="post-tag">
                  # ç¨³å®šæ€§
                </a>
              
                <a href="https://mzhtech.github.io/tag/_IpVibSEx/" class="post-tag">
                  # Golang
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <h2 id="å‰è¨€">å‰è¨€</h2>
<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚æœæŸä¸ªæœåŠ¡èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæˆ–è€…ç½‘ç»œå‘ç”Ÿå¼‚å¸¸ï¼Œéƒ½æœ‰å¯èƒ½å¯¼è‡´è°ƒç”¨æ–¹è¢«é˜»å¡ç­‰å¾…ã€‚å¦‚æœè¶…æ—¶æ—¶é—´è®¾ç½®å¾ˆé•¿ï¼Œè°ƒç”¨æ–¹èµ„æºå¾ˆå¯èƒ½è¢«è€—å°½ã€‚è¿™åˆå¯¼è‡´äº†è°ƒç”¨æ–¹çš„ä¸Šæ¸¸ç³»ç»Ÿå‘ç”Ÿèµ„æºè€—å°½çš„æƒ…å†µï¼Œæœ€ç»ˆå¯¼è‡´ç³»ç»Ÿé›ªå´©ã€‚</p>
<p>è¦é˜²æ­¢ç³»ç»Ÿå‘ç”Ÿé›ªå´©ï¼Œå°±å¿…é¡»è¦æœ‰å®¹é”™è®¾è®¡ã€‚å¦‚æœé‡åˆ°çªå¢æµé‡ï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯å¯¹éæ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½é‡‡ç”¨ç†”æ–­å’ŒæœåŠ¡é™çº§çš„æªæ–½æ¥ä¿æŠ¤æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½æ­£å¸¸æœåŠ¡ï¼Œè€Œå¯¹äºæ ¸å¿ƒåŠŸèƒ½æœåŠ¡ï¼Œåˆ™éœ€è¦é‡‡ç”¨é™æµçš„æªæ–½ã€‚</p>
<p>ä»Šå¤©æˆ‘ä»¬æ¥èŠä¸€èŠç³»ç»Ÿå®¹é”™ä¸­çš„é™æµã€ç†”æ–­å’ŒæœåŠ¡é™çº§ï¼Œå¹¶ä¸»è¦å¯¹é™æµçš„ç»å…¸ç®—æ³•è¿›è¡Œåˆ†æã€‚</p>
<p>ç›¸ä¿¡ä½ çœ‹å®Œæœ¬ç¯‡æ–‡ç« ï¼Œä¸€å®šèƒ½å¤Ÿå¯¹ç³»ç»Ÿå®¹é”™çš„å¸¸è§ç­–ç•¥â€”â€”é™æµã€ç†”æ–­ã€é™çº§æœ‰æ›´æ·±çš„ç†è§£å’Œä½“ä¼šã€‚</p>
<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<h3 id="1-ç†”æ–­å®¢æˆ·ç«¯">1. ç†”æ–­ï¼ˆå®¢æˆ·ç«¯ï¼‰</h3>
<p>åœ¨æœåŠ¡çš„ä¾èµ–è°ƒç”¨ä¸­ï¼Œè¢«è°ƒç”¨æ–¹å‡ºç°æ•…éšœæ—¶ï¼Œå‡ºäºè‡ªæˆ‘ä¿æŠ¤çš„ç›®çš„ï¼Œè°ƒç”¨æ–¹ä¼šä¸»åŠ¨åœæ­¢è°ƒç”¨ï¼Œå¹¶æ ¹æ®ä¸šåŠ¡éœ€è¦è¿›è¡Œç›¸åº”å¤„ç†ã€‚è°ƒç”¨æ–¹è¿™ç§ä¸»åŠ¨åœæ­¢è°ƒç”¨çš„è¡Œä¸ºæˆ‘ä»¬ç§°ä¹‹ä¸ºç†”æ–­ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆè¦ç†”æ–­">ä¸ºä»€ä¹ˆè¦ç†”æ–­ï¼Ÿ</h4>
<p>å‡å®šæœåŠ¡Aä¾èµ–æœåŠ¡Bï¼Œå½“æœåŠ¡Bå¤„äºæ­£å¸¸çŠ¶æ€ï¼Œæ•´ä¸ªè°ƒç”¨æ˜¯å¥åº·çš„ï¼ŒæœåŠ¡Aå¯ä»¥å¾—åˆ°æœåŠ¡Bçš„æ­£å¸¸å“åº”ã€‚å½“æœåŠ¡Bå‡ºç°æ•…éšœæ—¶ï¼Œæ¯”å¦‚å“åº”ç¼“æ…¢æˆ–è€…å“åº”è¶…æ—¶ï¼Œå¦‚æœæœåŠ¡Aç»§ç»­è¯·æ±‚æœåŠ¡Bï¼Œé‚£ä¹ˆæœåŠ¡Açš„å“åº”æ—¶é—´ä¹Ÿä¼šå¢åŠ ï¼Œè¿›è€Œå¯¼è‡´æœåŠ¡Aå“åº”ç¼“æ…¢ã€‚å¦‚æœæœåŠ¡Aä¸è¿›è¡Œç†”æ–­å¤„ç†ï¼ŒæœåŠ¡Bçš„æ•…éšœä¼šä¼ å¯¼è‡³æœåŠ¡Aï¼Œæœ€ç»ˆå¯¼è‡´æœåŠ¡Aä¹Ÿä¸å¯ç”¨ã€‚</p>
<h3 id="2-é™æµæœåŠ¡ç«¯">2. é™æµï¼ˆæœåŠ¡ç«¯ï¼‰</h3>
<p>é™æµæ˜¯é’ˆå¯¹æœåŠ¡è¯·æ±‚æ•°é‡çš„ä¸€ç§è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œå½“è¯·æ±‚æ•°é‡è¶…å‡ºæœåŠ¡çš„å¤„ç†èƒ½åŠ›æ—¶ï¼Œä¼šè‡ªåŠ¨ä¸¢å¼ƒæ–°æ¥çš„è¯·æ±‚ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆè¦é™æµ">ä¸ºä»€ä¹ˆè¦é™æµï¼Ÿ</h4>
<p>ä»»ä½•ä¸€ä¸ªç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›éƒ½æ˜¯æœ‰æé™çš„ï¼Œå‡å®šæœåŠ¡Açš„å¤„ç†èƒ½åŠ›ä¸ºQPS=100ï¼Œå½“QPS&lt;100æ—¶æœåŠ¡Aå¯ä»¥æä¾›æ­£å¸¸çš„æœåŠ¡ã€‚å½“QPS&gt;100æ—¶ï¼Œç”±äºè¯·æ±‚é‡å¢å¤§ï¼Œä¼šå‡ºç°äº‰æŠ¢æœåŠ¡èµ„æºçš„æƒ…å†µï¼ˆæ•°æ®åº“è¿æ¥ã€CPUã€å†…å­˜ç­‰ï¼‰ï¼Œå¯¼è‡´æœåŠ¡Aå¤„ç†ç¼“æ…¢ï¼›å½“QPSç»§ç»­å¢å¤§æ—¶ï¼Œå¯èƒ½ä¼šé€ æˆæœåŠ¡Aå“åº”æ›´åŠ ç¼“æ…¢ç”šè‡³å¥”æºƒã€‚å¦‚æœä¸è¿›è¡Œé™æµæ§åˆ¶ï¼ŒæœåŠ¡Aå§‹ç»ˆä¼šé¢ä¸´ç€è¢«å¤§æµé‡å†²å‡»çš„é£é™©ã€‚åšå¥½ç³»ç»Ÿè¯·æ±‚æµé‡çš„è¯„ä¼°ï¼Œåˆ¶å®šåˆç†çš„é™æµç­–ç•¥ï¼Œæ˜¯æˆ‘ä»¬è¿›è¡Œç³»ç»Ÿé«˜å¯ç”¨ä¿æŠ¤çš„ç¬¬ä¸€æ­¥ã€‚</p>
<h3 id="3-é™çº§">3. é™çº§</h3>
<p>é™çº§æ˜¯é€šè¿‡å¼€å…³é…ç½®å°†æŸäº›ä¸é‡è¦çš„ä¸šåŠ¡åŠŸèƒ½å±è”½æ‰ï¼Œä»¥æé«˜æœåŠ¡å¤„ç†èƒ½åŠ›ã€‚åœ¨å¤§ä¿ƒåœºæ™¯ä¸­ç»å¸¸ä¼šå¯¹æŸäº›æœåŠ¡è¿›è¡Œé™çº§å¤„ç†ï¼Œå¤§ä¿ƒç»“æŸä¹‹åå†è¿›è¡Œå¤åŸã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆè¦é™çº§">ä¸ºä»€ä¹ˆè¦é™çº§ï¼Ÿ</h4>
<p>åœ¨ä¸å½±å“ä¸šåŠ¡æ ¸å¿ƒé“¾è·¯çš„æƒ…å†µä¸‹ï¼Œå±è”½æŸäº›ä¸é‡è¦çš„ä¸šåŠ¡åŠŸèƒ½ï¼Œå¯ä»¥èŠ‚çœç³»ç»Ÿçš„å¤„ç†æ—¶é—´ï¼Œæä¾›ç³»ç»Ÿçš„å“åº”èƒ½åŠ›ï¼Œåœ¨æœåŠ¡å™¨èµ„æºå›ºå®šçš„å‰æä¸‹å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚</p>
<h2 id="ç†”æ–­">ç†”æ–­</h2>
<p>æ— è®ºæ˜¯ä»¤ç‰Œæ¡¶ã€æ¼æ¡¶è¿˜æ˜¯è‡ªé€‚åº”é™æµçš„æ–¹æ³•ï¼Œæ€»çš„æ¥è¯´éƒ½æ˜¯æœåŠ¡ç«¯çš„å•æœºé™æµæ–¹å¼ã€‚è™½ç„¶æœåŠ¡ç«¯é™æµå¯ä»¥å¸®åŠ©æˆ‘ä»¬æŠ—ä½ä¸€å®šçš„å‹åŠ›ï¼Œä½†æ˜¯æ‹’ç»è¯·æ±‚æ¯•ç«Ÿè¿˜æ˜¯æœ‰æˆæœ¬çš„ã€‚å¦‚æœæˆ‘ä»¬çš„æœ¬æ¥æµé‡å¯ä»¥æ”¯æ’‘1w QPSï¼ŒåŠ äº†é™æµå¯ä»¥æ”¯æ’‘åœ¨10w QPSçš„æƒ…å†µä¸‹ä»ç„¶å¯ä»¥æä¾›1w QPSçš„æœ‰æ•ˆè¯·æ±‚ï¼Œä½†æ˜¯æµé‡çªç„¶å†ç¿»äº†10å€ï¼Œæ¥åˆ°100w QPSï¼Œé‚£ä¹ˆæœåŠ¡è¯¥æŒ‚è¿˜æ˜¯å¾—æŒ‚ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬çš„å¯ç”¨æ€§å»ºè®¾ä¸ä»…ä»…æ˜¯æœåŠ¡ç«¯åšå»ºè®¾å°±å¯ä»¥ä¸‡äº‹å¤§å‰äº†ï¼Œå¾—åœ¨æ•´ä¸ªé“¾è·¯ä¸Šçš„æ¯ä¸ªç»„ä»¶éƒ½åšå¥½è‡ªå·±çš„äº‹æƒ…æ‰è¡Œï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥ä¸€èµ·çœ‹ä¸€ä¸‹å®¢æˆ·ç«¯ä¸Šçš„é™æµæªæ–½ï¼šç†”æ–­ã€‚</p>
<p>ç†”æ–­å™¨å­˜åœ¨ä¸‰ç§çŠ¶æ€ï¼š</p>
<ul>
<li><strong>å…³é—­ (closed)</strong>: å…³é—­çŠ¶æ€ä¸‹æ²¡æœ‰è§¦å‘æ–­è·¯ä¿æŠ¤ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½æ­£å¸¸é€šè¡Œã€‚</li>
<li><strong>æ‰“å¼€ (open)</strong>: å½“é”™è¯¯é˜ˆå€¼è§¦å‘ä¹‹åï¼Œå°±è¿›å…¥å¼€å¯çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™æ‰€æœ‰çš„æµé‡éƒ½ä¼šè¢«èŠ‚æµï¼Œä¸è¿è¡Œé€šè¡Œã€‚</li>
<li><strong>åŠæ‰“å¼€ (half-open)</strong>: å¤„äºæ‰“å¼€çŠ¶æ€ä¸€æ®µæ—¶é—´ä¹‹åï¼Œä¼šå°è¯•æ”¾è¡Œä¸€ä¸ªæµé‡æ¥æ¢æµ‹å½“å‰ server ç«¯æ˜¯å¦å¯ä»¥æ¥æ”¶æ–°æµé‡ï¼Œå¦‚æœæ²¡æœ‰é—®é¢˜å°±ä¼šè¿›å…¥å…³é—­çŠ¶æ€ï¼Œå¦‚æœæœ‰é—®é¢˜åˆä¼šå›åˆ°æ‰“å¼€çŠ¶æ€ã€‚</li>
</ul>
<h2 id="æ–¹æ¡ˆå¯¹æ¯”">æ–¹æ¡ˆå¯¹æ¯”</h2>
<h3 id="hystrix-go">Hystrix-Go</h3>
<p>ç†”æ–­å™¨ä¸­æ¯”è¾ƒå…¸å‹çš„å®ç°å°±æ˜¯ Hystrixã€‚</p>
<p><strong>å‚è€ƒé“¾æ¥</strong>ï¼š<a href="%E9%93%BE%E6%8E%A5">hystrix-go ä½¿ç”¨ä¸åŸç† | Go æŠ€æœ¯è®ºå›</a></p>
<p>Hystrix æ˜¯ç”± Netflix å¼€å‘çš„ä¸€æ¬¾å¼€æºç»„ä»¶ï¼Œæä¾›äº†åŸºç¡€çš„ç†”æ–­åŠŸèƒ½ã€‚Hystrix å°†é™çº§çš„ç­–ç•¥å°è£…åœ¨ Command ä¸­ï¼Œæä¾›äº† run å’Œ fallback ä¸¤ä¸ªæ–¹æ³•ï¼Œå‰è€…è¡¨ç¤ºæ­£å¸¸çš„é€»è¾‘ï¼Œæ¯”å¦‚å¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨â€¦â€¦å¦‚æœå‘ç”Ÿäº†æ•…éšœï¼Œå†æ‰§è¡Œ fallback æ–¹æ³•è¿”å›ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£æˆä¿åº•æ“ä½œã€‚å¦‚æœæ­£å¸¸é€»è¾‘åœ¨çŸ­æ—¶é—´å†…é¢‘ç¹å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆå¯èƒ½ä¼šè§¦å‘çŸ­è·¯ï¼Œä¹Ÿå°±æ˜¯ä¹‹åçš„è¯·æ±‚ä¸å†æ‰§è¡Œ runï¼Œè€Œæ˜¯ç›´æ¥æ‰§è¡Œ fallbackã€‚</p>
<p>æ›´å¤šå…³äº Hystrix çš„ä¿¡æ¯å¯ä»¥æŸ¥çœ‹ <a href="https://github.com/Netflix/Hystrix">GitHub</a>ï¼Œè€Œ Hystrix-Go åˆ™æ˜¯ç”¨ Go å®ç°çš„ Hystrix ç‰ˆï¼Œæ›´ç¡®åˆ‡çš„è¯´ï¼Œæ˜¯ç®€åŒ–ç‰ˆã€‚</p>
<h3 id="ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³•ï¼š</h3>
<p>Hystrix å®ç°ç†”æ–­ä¸€èˆ¬åŒ…æ‹¬ä¸¤æ­¥ï¼š</p>
<ol>
<li><strong>é…ç½®ç†”æ–­è§„åˆ™</strong></li>
<li><strong>è®¾ç½®ç†”æ–­é€»è¾‘</strong></li>
</ol>
<p>ä¸€ä¸ªç®€å•çš„ğŸŒ°ï¼š</p>
<pre><code class="language-go">// ç¬¬ä¸€æ­¥ï¼šé…ç½®ç†”æ–­è§„åˆ™
hystrix.ConfigureCommand(&quot;wuqq&quot;, hystrix.CommandConfig{
        Timeout:                int(3 * time.Second),
        MaxConcurrentRequests:  10,
        SleepWindow:            5000,
        RequestVolumeThreshold: 10,
        ErrorPercentThreshold:  30,
    })

// ç¬¬äºŒæ­¥ï¼šè®¾ç½®ç†”æ–­é€»è¾‘
// Do æ˜¯å¼‚æ­¥ï¼ŒGo æ˜¯åŒæ­¥

_ = hystrix.Do(&quot;wuqq&quot;, func() error {
    // talk to other services
    _, err := http.Get(&quot;https://www.baidu.com/&quot;)
    if err != nil {
        fmt.Println(&quot;get error:%v&quot;, err)
        return err
    }
    return nil
}, func(err error) error {
    fmt.Printf(&quot;handle error:%v\n&quot;, err)
    return nil
})
</code></pre>
<p><strong>Do å‡½æ•°éœ€è¦ä¸‰ä¸ªå‚æ•°</strong>ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ command åç§°ï¼Œä½ å¯ä»¥æŠŠæ¯ä¸ªåç§°å½“æˆä¸€ä¸ªç‹¬ç«‹çš„æœåŠ¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¤„ç†æ­£å¸¸çš„é€»è¾‘ï¼Œæ¯”å¦‚ HTTP è°ƒç”¨æœåŠ¡ï¼Œè¿”å›å‚æ•°æ˜¯ errã€‚å¦‚æœå¤„ç†è°ƒç”¨å¤±è´¥ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œç¬¬ä¸‰ä¸ªå‚æ•°é€»è¾‘ï¼Œæˆ‘ä»¬ç§°ä¸ºä¿åº•æ“ä½œã€‚ç”±äºæœåŠ¡é”™è¯¯ç‡è¿‡é«˜å¯¼è‡´ç†”æ–­å™¨å¼€å¯ï¼Œé‚£ä¹ˆä¹‹åçš„è¯·æ±‚ä¹Ÿç›´æ¥å›è°ƒæ­¤å‡½æ•°ã€‚</p>
<h3 id="é…ç½®å‚æ•°å«ä¹‰">é…ç½®å‚æ•°å«ä¹‰ï¼š</h3>
<ul>
<li><strong>Timeout</strong>: æ‰§è¡Œ command çš„è¶…æ—¶æ—¶é—´ã€‚</li>
<li><strong>MaxConcurrentRequests</strong>: command çš„æœ€å¤§å¹¶å‘é‡ã€‚</li>
<li><strong>SleepWindow</strong>: å½“ç†”æ–­å™¨è¢«æ‰“å¼€åï¼ŒSleepWindow çš„æ—¶é—´å°±æ˜¯æ§åˆ¶è¿‡å¤šä¹…åå»å°è¯•æœåŠ¡æ˜¯å¦å¯ç”¨äº†ã€‚</li>
<li><strong>RequestVolumeThreshold</strong>: ä¸€ä¸ªç»Ÿè®¡çª—å£ 10 ç§’å†…è¯·æ±‚æ•°é‡ã€‚è¾¾åˆ°è¿™ä¸ªè¯·æ±‚æ•°é‡åæ‰å»åˆ¤æ–­æ˜¯å¦è¦å¼€å¯ç†”æ–­ã€‚</li>
<li><strong>ErrorPercentThreshold</strong>: é”™è¯¯ç™¾åˆ†æ¯”ï¼Œè¯·æ±‚æ•°é‡å¤§äºç­‰äº RequestVolumeThreshold å¹¶ä¸”é”™è¯¯ç‡åˆ°è¾¾è¿™ä¸ªç™¾åˆ†æ¯”åå°±ä¼šå¯åŠ¨ç†”æ–­ã€‚</li>
</ul>
<h3 id="æ ¸å¿ƒå®ç°">æ ¸å¿ƒå®ç°</h3>
<p>æ ¸å¿ƒå®ç°çš„æ–¹æ³•æ˜¯ AllowRequestï¼ŒIsOpen åˆ¤æ–­å½“å‰æ˜¯å¦å¤„äºç†”æ–­çŠ¶æ€ï¼ŒallowSingleTest å°±æ˜¯å»çœ‹æ˜¯å¦è¿‡äº†ä¸€æ®µæ—¶é—´éœ€è¦é‡æ–°è¿›è¡Œå°è¯•ã€‚</p>
<pre><code class="language-go">func (circuit *CircuitBreaker) AllowRequest() bool {        
    return !circuit.IsOpen() || circuit.allowSingleTest()
}

func (circuit *CircuitBreaker) IsOpen() bool {
   circuit.mutex.RLock()
   o := circuit.forceOpen || circuit.open
   circuit.mutex.RUnlock()

   if o {
      return true
   }

   if uint64(circuit.metrics.Requests().Sum(time.Now())) &lt; getSettings(circuit.Name).RequestVolumeThreshold {
      return false
   }

   if !circuit.metrics.IsHealthy(time.Now()) {
      // too many failures, open the circuit
      circuit.setOpen()
      return true
   }

   return false
}
</code></pre>
<p>Hystrix-Go å·²ç»å¯ä»¥æ¯”è¾ƒå¥½åœ°æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯ä¸€æ—¦è§¦å‘äº†ç†”æ–­ï¼Œåœ¨ä¸€æ®µæ—¶é—´ä¹‹å†…å°±ä¼šè¢«ä¸€åˆ€åˆ‡åœ°æ‹¦æˆªè¯·æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥çœ‹çœ‹ Google SRE çš„ä¸€ä¸ªå®ç°ã€‚</p>
<h2 id="google-sreä¿æŠ¤ç®—æ³•">Google SREä¿æŠ¤ç®—æ³•</h2>
<p>è¿™ä¸ªç®—æ³•çš„å¥½å¤„æ˜¯ä¸ä¼šç›´æ¥ä¸€åˆ€åˆ‡çš„ä¸¢å¼ƒæ‰€æœ‰è¯·æ±‚ï¼Œè€Œæ˜¯è®¡ç®—å‡ºä¸€ä¸ªæ¦‚ç‡æ¥è¿›è¡Œåˆ¤æ–­ã€‚å½“æˆåŠŸçš„è¯·æ±‚æ•°é‡è¶Šå°‘ï¼ŒK è¶Šå°çš„æ—¶å€™è®¡ç®—å‡ºçš„æ¦‚ç‡å°±è¶Šå¤§ï¼Œè¡¨ç¤ºè¿™ä¸ªè¯·æ±‚è¢«ä¸¢å¼ƒçš„æ¦‚ç‡è¶Šå¤§ã€‚</p>
<h3 id="kratosæºç åˆ†æ">Kratosæºç åˆ†æ</h3>
<pre><code class="language-go">func (b *sreBreaker) Allow() error {
   // ç»Ÿè®¡æˆåŠŸçš„è¯·æ±‚ï¼Œå’Œæ€»çš„è¯·æ±‚
   success, total := b.summary()

   // è®¡ç®—å½“å‰çš„æˆåŠŸç‡
   k := b.k * float64(success)
   if log.V(5) {
      log.Info(&quot;breaker: request: %d, succeed: %d, fail: %d&quot;, total, success, total-success)
   }
   // ç»Ÿè®¡è¯·æ±‚é‡å’ŒæˆåŠŸç‡
   // å¦‚æœ qps æ¯”è¾ƒå°ï¼Œä¸è§¦å‘ç†”æ–­
   // å¦‚æœæˆåŠŸç‡æ¯”è¾ƒé«˜ï¼Œä¸è§¦å‘ç†”æ–­ï¼Œå¦‚æœ k = 2ï¼Œé‚£ä¹ˆå°±æ˜¯æˆåŠŸç‡ &gt;= 50% çš„æ—¶å€™å°±ä¸ç†”æ–­
   if total &lt; b.request || float64(total) &lt; k {
      if atomic.LoadInt32(&amp;b.state) == StateOpen {
         atomic.CompareAndSwapInt32(&amp;b.state, StateOpen, StateClosed)
      }
      return nil
   }
   if atomic.LoadInt32(&amp;b.state) == StateClosed {
      atomic.CompareAndSwapInt32(&amp;b.state, StateClosed, StateOpen)
   }

   // è®¡ç®—ä¸€ä¸ªæ¦‚ç‡ï¼Œå½“ dr å€¼è¶Šå¤§ï¼Œé‚£ä¹ˆè¢«ä¸¢å¼ƒçš„æ¦‚ç‡ä¹Ÿå°±è¶Šå¤§
   // dr å€¼æ˜¯ï¼Œå¦‚æœå¤±è´¥ç‡è¶Šé«˜æˆ–è€…æ˜¯ k å€¼è¶Šå°ï¼Œé‚£ä¹ˆå®ƒè¶Šå¤§
   dr := math.Max(0, (float64(total)-k)/float64(total+1))
   drop := b.trueOnProba(dr)
   if log.V(5) {
      log.Info(&quot;breaker: drop ratio: %f, drop: %t&quot;, dr, drop)
   }
   if drop {
      return ecode.ServiceUnavailable
   }
   return nil
}

// é€šè¿‡éšæœºæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œç†”æ–­
func (b *sreBreaker) trueOnProba(proba float64) (truth bool) {
   b.randLock.Lock()
   truth = b.r.Float64() &lt; proba
   b.randLock.Unlock()
   return
}
</code></pre>
<p><strong>å‚è€ƒé“¾æ¥</strong>ï¼š<a href="%E9%93%BE%E6%8E%A5">Goå¯ç”¨æ€§(å…­) ç†”æ–­ - Mohuishou</a></p>
<h2 id="ç†”æ–­ä¸-failover-ç»“åˆçš„æ€æƒ³">ç†”æ–­ä¸ Failover ç»“åˆçš„æ€æƒ³</h2>
<p>ä¸€å¥è¯æ€»ç»“ï¼šè¯·æ±‚å…ˆè¿›å…¥ CircuitBreaker æ ¹æ®å½“å‰ç†”æ–­å™¨ç­–ç•¥å†³å®šè¯·æ±‚ä¸»é›†ç¾¤æˆ–å¤‡é›†ç¾¤ï¼Œè‹¥è¯·æ±‚ä¸»é›†ç¾¤ä¸”ä¸»é›†ç¾¤è¯·æ±‚å¤±è´¥ï¼Œåˆ™è¿›å…¥ Failover é€»è¾‘ Failover åˆ°å¤‡é›†ç¾¤ä¸­è·å–æ•°æ®ã€‚</p>
<p><strong>å‚è€ƒé“¾æ¥</strong>ï¼š<a href="%E9%93%BE%E6%8E%A5">CS-SP-Relation-40-Stability - é€šç”¨è‡ªåŠ¨å®¹ç¾ç»„ä»¶æ–¹æ¡ˆ</a></p>
<h2 id="é™æµ">é™æµ</h2>
<p>é™æµï¼Œä¹Ÿç§°æµé‡æ§åˆ¶ã€‚æ˜¯æŒ‡ç³»ç»Ÿåœ¨é¢ä¸´é«˜å¹¶å‘ï¼Œæˆ–è€…å¤§æµé‡è¯·æ±‚çš„æƒ…å†µä¸‹ï¼Œé™åˆ¶æ–°çš„è¯·æ±‚å¯¹ç³»ç»Ÿçš„è®¿é—®ï¼Œä»è€Œä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚é™æµä¼šå¯¼è‡´éƒ¨åˆ†ç”¨æˆ·è¯·æ±‚å¤„ç†ä¸åŠæ—¶æˆ–è€…è¢«æ‹’ï¼Œè¿™å°±å½±å“äº†ç”¨æˆ·ä½“éªŒã€‚æ‰€ä»¥ä¸€èˆ¬éœ€è¦åœ¨ç³»ç»Ÿç¨³å®šå’Œç”¨æˆ·ä½“éªŒä¹‹é—´å¹³è¡¡ä¸€ä¸‹ã€‚</p>
<h3 id="1-å›ºå®šçª—å£">1. å›ºå®šçª—å£</h3>
<p>å›ºå®šæ—¶é—´å†…å¯¹è¯·æ±‚æ•°è¿›è¡Œé™åˆ¶ï¼Œä¾‹å¦‚è¯´æ¯ç§’è¯·æ±‚ä¸è¶…è¿‡50æ¬¡ï¼Œé‚£å°±åœ¨0-1ç§’ï¼Œ1-2ç§’â€¦â€¦n-n+1ç§’ï¼Œæ¯ç§’ä¸è¶…è¿‡50æ¬¡è¯·æ±‚ã€‚</p>
<p>å¯æ˜¯ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨0.99ç§’å’Œ1.01ç§’åˆ†åˆ«æœ‰50æ¬¡è¯·æ±‚ï¼Œå¯¹äºå›ºå®šçª—å£æ–¹æ³•ï¼Œä¸ä¼šé™æµï¼Œä½†æ˜¯å®é™…ä¸Šåœ¨0.99ç§’-1.01ç§’ï¼Œè¿™ä¸€æ®µä¸åˆ°1sçš„æ—¶é—´å†…å·²ç»è¾¾åˆ°äº†é˜€å€¼çš„ä¸¤å€ï¼Œä»¥ä¸‹çš„æ»‘åŠ¨çª—å£æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h3 id="2-æ»‘åŠ¨çª—å£">2. æ»‘åŠ¨çª—å£</h3>
<h4 id="ç®—æ³•æ€æƒ³">ç®—æ³•æ€æƒ³</h4>
<p>æ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼Œæ˜¯å¯¹æ™®é€šæ—¶é—´çª—å£è®¡æ•°çš„ä¼˜åŒ–ã€‚</p>
<p>ä½¿ç”¨æ™®é€šæ—¶é—´çª—å£æ—¶ï¼Œæˆ‘ä»¬ä¼šä¸ºæ¯ä¸ª user_id/ip ç»´æŠ¤ä¸€ä¸ª KV: uidOrIp: timestamp_requestCountã€‚å‡è®¾é™åˆ¶1ç§’1000ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆç¬¬100msæœ‰ä¸€ä¸ªè¯·æ±‚ï¼Œè¿™ä¸ª KV å˜æˆ uidOrIp: timestamp_1ï¼Œé€’200msæœ‰1ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬å…ˆæ¯”è¾ƒè·ç¦»è®°å½•çš„ timestamp æœ‰æ²¡æœ‰è¶…è¿‡1sï¼Œå¦‚æœæ²¡æœ‰åªæ›´æ–° countï¼Œæ­¤æ—¶ KV å˜æˆ uidOrIp: timestamp_2ã€‚å½“ç¬¬1100msæ¥ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œæ›´æ–°è®°å½•ä¸­çš„ timestamp å¹¶é‡ç½®è®¡æ•°ï¼ŒKV å˜æˆ uidOrIp: newtimestamp_1ã€‚</p>
<p>æ™®é€šæ—¶é—´çª—å£æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå‡è®¾æœ‰500ä¸ªè¯·æ±‚é›†ä¸­åœ¨å‰1sçš„å100msï¼Œ500ä¸ªè¯·æ±‚é›†ä¸­åœ¨å1sçš„å‰100msï¼Œå…¶å®åœ¨è¿™200mså†…å·²ç»è¯·æ±‚è¶…é™äº†ï¼Œä½†æ˜¯ç”±äºæ—¶é—´çª—æ¯ç»è¿‡1så°±ä¼šé‡ç½®è®¡æ•°ï¼Œå°±æ— æ³•è¯†åˆ«åˆ°æ­¤æ—¶çš„è¯·æ±‚è¶…é™ã€‚</p>
<p>å¯¹äºæ»‘åŠ¨æ—¶é—´çª—å£ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ1msçš„æ—¶é—´çª—å£åˆ’åˆ†æˆ10ä¸ª time slotï¼Œæ¯ä¸ª time slot ç»Ÿè®¡æŸä¸ª100msçš„è¯·æ±‚æ•°é‡ã€‚æ¯ç»è¿‡100msï¼Œæœ‰ä¸€ä¸ªæ–°çš„ time slot åŠ å…¥çª—å£ï¼Œæ—©äºå½“å‰æ—¶é—´100msçš„ time slot å‡ºçª—å£ã€‚çª—å£å†…æœ€å¤šç»´æŠ¤10ä¸ª time slotï¼Œå‚¨å­˜ç©ºé—´çš„æ¶ˆè€—åŒæ ·æ˜¯æ¯”è¾ƒä½çš„ã€‚</p>
<h4 id="é€‚ç”¨åœºæ™¯">é€‚ç”¨åœºæ™¯</h4>
<p>ä¸ä»¤ç‰Œæ¡¶ä¸€æ ·ï¼Œæœ‰åº”å¯¹çªå‘æµé‡çš„èƒ½åŠ›ã€‚</p>
<h3 id="goè¯­è¨€å®ç°">Goè¯­è¨€å®ç°</h3>
<p>ä¸»è¦å°±æ˜¯å®ç° sliding window ç®—æ³•ã€‚å¯ä»¥å‚è€ƒ Bilibili å¼€æºçš„ kratos æ¡†æ¶é‡Œ circuit breaker ç”¨å¾ªç¯åˆ—è¡¨ä¿å­˜ time slot å¯¹è±¡çš„å®ç°ï¼Œä»–ä»¬è¿™ä¸ªå®ç°çš„å¥½å¤„æ˜¯ä¸ç”¨é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯ time slot å¯¹è±¡ã€‚ä¸‹é¢ç»™å‡ºä¸€ä¸ªç®€å•çš„åŸºæœ¬å®ç°ï¼š</p>
<pre><code class="language-go">package main

import (
        &quot;fmt&quot;
        &quot;sync&quot;
        &quot;time&quot;
)

var winMu map[string]*sync.RWMutex

func init() {
        winMu = make(map[string]*sync.RWMutex)
}

type timeSlot struct {
        timestamp time.Time // è¿™ä¸ª timeSlot çš„æ—¶é—´èµ·ç‚¹
        count     int       // è½åœ¨è¿™ä¸ª timeSlot å†…çš„è¯·æ±‚æ•°
}

func countReq(win []*timeSlot) int {
        var count int
        for _, ts := range win {
                count += ts.count
        }
        return count
}

type SlidingWindowLimiter struct {
        SlotDuration time.Duration // time slot çš„é•¿åº¦
        WinDuration  time.Duration // sliding window çš„é•¿åº¦
        numSlots     int           // window å†…æœ€å¤šæœ‰å¤šå°‘ä¸ª slot
        windows      map[string][]*timeSlot
        maxReq       int // win duration å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°
}

func NewSliding(slotDuration time.Duration, winDuration time.Duration, maxReq int) *SlidingWindowLimiter {
        return &amp;SlidingWindowLimiter{
                SlotDuration: slotDuration,
                WinDuration:  winDuration,
                numSlots:     int(winDuration / slotDuration),
                windows:      make(map[string][]*timeSlot),
                maxReq:       maxReq,
        }
}

// è·å– user_id/ip çš„æ—¶é—´çª—å£
func (l *SlidingWindowLimiter) getWindow(uidOrIp string) []*timeSlot {
        win, ok := l.windows[uidOrIp]
        if !ok {
                win = make([]*timeSlot, 0, l.numSlots)
        }
        return win
}

func (l *SlidingWindowLimiter) storeWindow(uidOrIp string, win []*timeSlot) {
        l.windows[uidOrIp] = win
}

func (l *SlidingWindowLimiter) validate(uidOrIp string) bool {
        // åŒä¸€ user_id/ip å¹¶å‘å®‰å…¨
        mu, ok := winMu[uidOrIp]
        if !ok {
                var m sync.RWMutex
                mu = &amp;m
                winMu[uidOrIp] = mu
        }
        mu.Lock()
        defer mu.Unlock()

        win := l.getWindow(uidOrIp)
        now := time.Now()
        // å·²ç»è¿‡æœŸçš„ time slot ç§»å‡ºæ—¶é—´çª—
        timeoutOffset := -1
        for i, ts := range win {
                if ts.timestamp.Add(l.WinDuration).After(now) {
                        break
                }
                timeoutOffset = i
        }
        if timeoutOffset &gt; -1 {
                win = win[timeoutOffset+1:]
        }

        // åˆ¤æ–­è¯·æ±‚æ˜¯å¦è¶…é™
        var result bool
        if countReq(win) &lt; l.maxReq {
                result = true
        }

        // è®°å½•è¿™æ¬¡çš„è¯·æ±‚æ•°
        var lastSlot *timeSlot
        if len(win) &gt; 0 {
                lastSlot = win[len(win)-1]
                if lastSlot.timestamp.Add(l.SlotDuration).Before(now) {
                        lastSlot = &amp;timeSlot{timestamp: now, count: 1}
                        win = append(win, lastSlot)
                } else {
                        lastSlot.count++
                }
        } else {
                lastSlot = &amp;timeSlot{timestamp: now, count: 1}
                win = append(win, lastSlot)
        }

        l.storeWindow(uidOrIp, win)

        return result
}

func (l *SlidingWindowLimiter) getUidOrIp() string {
        return &quot;127.0.0.1&quot;
}

func (l *SlidingWindowLimiter) IsLimited() bool {
        return !l.validate(l.getUidOrIp())
}

func main() {
        limiter := NewSliding(100*time.Millisecond, time.Second, 10)
        for i := 0; i &lt; 5; i++ {
                fmt.Println(limiter.IsLimited())
        }
        time.Sleep(100 * time.Millisecond)
        for i := 0; i &lt; 5; i++ {
                fmt.Println(limiter.IsLimited())
        }
        fmt.Println(limiter.IsLimited())
        for _, v := range limiter.windows[limiter.getUidOrIp()] {
                fmt.Println(v.timestamp, v.count)
        }

        fmt.Println(&quot;a thousand years later...&quot;)
        time.Sleep(time.Second)
        for i := 0; i &lt; 7; i++ {
                fmt.Println(limiter.IsLimited())
        }
        for _, v := range limiter.windows[limiter.getUidOrIp()] {
                fmt.Println(v.timestamp, v.count)
        }
}
</code></pre>
<h3 id="3-æ¼æ¡¶">3. æ¼æ¡¶</h3>
<h4 id="ç®—æ³•æ€æƒ³-2">ç®—æ³•æ€æƒ³</h4>
<p>ä¸ä»¤ç‰Œæ¡¶æ˜¯â€œåå‘â€çš„ç®—æ³•ï¼Œå½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶å…ˆæ”¾åˆ°æœ¨æ¡¶ä¸­ï¼Œworker ä»¥å›ºå®šçš„é€Ÿåº¦ä»æœ¨æ¡¶ä¸­å–å‡ºè¯·æ±‚è¿›è¡Œå“åº”ã€‚å¦‚æœæœ¨æ¡¶å·²ç»æ»¡äº†ï¼Œç›´æ¥è¿”å›è¯·æ±‚é¢‘ç‡è¶…é™çš„é”™è¯¯ç æˆ–è€…é¡µé¢ã€‚</p>
<h4 id="é€‚ç”¨åœºæ™¯-2">é€‚ç”¨åœºæ™¯</h4>
<p>æµé‡æœ€å‡åŒ€çš„é™æµæ–¹å¼ï¼Œä¸€èˆ¬ç”¨äºæµé‡â€œæ•´å½¢â€ï¼Œä¾‹å¦‚ä¿æŠ¤æ•°æ®åº“çš„é™æµã€‚å…ˆæŠŠå¯¹æ•°æ®åº“çš„è®¿é—®åŠ å…¥åˆ°æœ¨æ¡¶ä¸­ï¼Œworker å†ä»¥ db èƒ½å¤Ÿæ‰¿å—çš„ QPS ä»æœ¨æ¡¶ä¸­å–å‡ºè¯·æ±‚ï¼Œå»è®¿é—®æ•°æ®åº“ã€‚ä¸å¤ªé€‚åˆç”µå•†æŠ¢è´­å’Œå¾®åšå‡ºç°çƒ­ç‚¹äº‹ä»¶ç­‰åœºæ™¯çš„é™æµï¼Œä¸€æ˜¯åº”å¯¹çªå‘æµé‡ä¸æ˜¯å¾ˆçµæ´»ï¼ŒäºŒæ˜¯ä¸ºæ¯ä¸ª user_id/ip ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆæœ¨æ¡¶ï¼‰ï¼Œworker ä»è¿™äº›é˜Ÿåˆ—ä¸­æ‹‰å–ä»»åŠ¡ï¼Œèµ„æºçš„æ¶ˆè€—ä¼šæ¯”è¾ƒå¤§ã€‚</p>
<h3 id="goè¯­è¨€å®ç°-2">Goè¯­è¨€å®ç°</h3>
<p>é€šå¸¸ä½¿ç”¨é˜Ÿåˆ—æ¥å®ç°ï¼Œåœ¨ Go è¯­è¨€ä¸­å¯ä»¥é€šè¿‡ buffered channel æ¥å¿«é€Ÿå®ç°ï¼Œä»»åŠ¡åŠ å…¥ channelï¼Œå¼€å¯ä¸€å®šæ•°é‡çš„ worker ä» channel ä¸­è·å–ä»»åŠ¡æ‰§è¡Œã€‚</p>
<pre><code class="language-go">package main

import (
        &quot;fmt&quot;
        &quot;sync&quot;
        &quot;time&quot;
)

// æ¯ä¸ªè¯·æ±‚æ¥äº†ï¼ŒæŠŠéœ€è¦æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘å°è£…æˆ Taskï¼Œæ”¾å…¥æœ¨æ¡¶ï¼Œç­‰å¾… worker å–å‡ºæ‰§è¡Œ
type Task struct {
        handler func() Result // worker ä»æœ¨æ¡¶ä¸­å–å‡ºè¯·æ±‚å¯¹è±¡åè¦æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘å‡½æ•°
        resChan chan Result   // ç­‰å¾… worker æ‰§è¡Œå¹¶è¿”å›ç»“æœçš„ channel
        taskID  int
}

//å°è£…ä¸šåŠ¡é€»è¾‘çš„æ‰§è¡Œç»“æœ
type Result struct {}

// æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘çš„å‡½æ•°
func handler() Result {
        time.Sleep(300 * time.Millisecond)
        return Result{}
}

func NewTask(id int) Task {
        return Task{
                handler: handler,
                resChan: make(chan Result),
                taskID:  id,
        }
}

// æ¼æ¡¶
type LeakyBucket struct {
        BucketSize int       // æœ¨æ¡¶çš„å¤§å°
        NumWorker  int       // åŒæ—¶ä»æœ¨æ¡¶ä¸­è·å–ä»»åŠ¡æ‰§è¡Œçš„ worker æ•°é‡
        bucket     chan Task // å­˜æ”¾ä»»åŠ¡çš„æœ¨æ¡¶
}

func NewLeakyBucket(bucketSize int, numWorker int) *LeakyBucket {
        return &amp;LeakyBucket{
                BucketSize: bucketSize,
                NumWorker:  numWorker,
                bucket:     make(chan Task, bucketSize),
        }
}

func (b *LeakyBucket) validate(task Task) bool {
        // å¦‚æœæœ¨æ¡¶å·²ç»æ»¡äº†ï¼Œè¿”å› false
        select {
        case b.bucket &lt;- task:
        default:
                fmt.Printf(&quot;request[id=%d] is refused\n&quot;, task.taskID)
                return false
        }

        // ç­‰å¾… worker æ‰§è¡Œ
        &lt;-task.resChan
        fmt.Printf(&quot;request[id=%d] is run\n&quot;, task.taskID)
        return true
}

func (b *LeakyBucket) Start() {
        // å¼€å¯ worker ä»æœ¨æ¡¶æ‹‰å–ä»»åŠ¡æ‰§è¡Œ
        go func() {
                for i := 0; i &lt; b.NumWorker; i++ {
                        go func() {
                                for {
                                        task := &lt;-b.bucket
                                        result := task.handler()
                                        task.resChan &lt;- result
                                }
                        }()
                }
        }()
}

func main() {
        bucket := NewLeakyBucket(10, 4)
        bucket.Start()

        var wg sync.WaitGroup
        for i := 0; i &lt; 20; i++ {
                wg.Add(1)
                go func(id int) {
                        defer wg.Done()
                        task := NewTask(id)
                        bucket.validate(task)
                }(i)
        }
        wg.Wait()
}
</code></pre>
<h3 id="å¸¸è§è°ƒåŒ…ä½¿ç”¨">å¸¸è§è°ƒåŒ…ä½¿ç”¨</h3>
<ul>
<li><strong>ratelimit package</strong> - <code>go.uber.org/ratelimit</code></li>
</ul>
<h3 id="4-ä»¤ç‰Œæ¡¶">4. ä»¤ç‰Œæ¡¶</h3>
<h4 id="ç®—æ³•æ€æƒ³-3">ç®—æ³•æ€æƒ³</h4>
<p>ä»¤ç‰Œæ¡¶æ˜¯ç›®å‰ä½¿ç”¨æ¯”è¾ƒå¹¿æ³›çš„é™æµæ–¹å¼ã€‚</p>
<p>æƒ³è±¡æœ‰ä¸€ä¸ªæœ¨æ¡¶ï¼Œä»¥å›ºå®šçš„é€Ÿåº¦å¾€æœ¨æ¡¶é‡ŒåŠ å…¥ä»¤ç‰Œï¼Œæœ¨æ¡¶æ»¡äº†åˆ™ä¸å†åŠ å…¥ä»¤ç‰Œã€‚æœåŠ¡æ”¶åˆ°è¯·æ±‚æ—¶å°è¯•ä»æœ¨æ¡¶ä¸­å–å‡ºä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æœèƒ½å¤Ÿå¾—åˆ°ä»¤ç‰Œåˆ™ç»§ç»­æ‰§è¡Œåç»­çš„ä¸šåŠ¡é€»è¾‘ï¼›å¦‚æœæ²¡æœ‰å¾—åˆ°ä»¤ç‰Œï¼Œç›´æ¥è¿”å›è¯·æ±‚é¢‘ç‡è¶…é™çš„é”™è¯¯ç æˆ–é¡µé¢ç­‰ï¼Œä¸ç»§ç»­æ‰§è¡Œåç»­çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p><strong>ç‰¹ç‚¹</strong>ï¼šç”±äºæœ¨æ¡¶å†…åªè¦æœ‰ä»¤ç‰Œï¼Œè¯·æ±‚å°±å¯ä»¥è¢«å¤„ç†ï¼Œæ‰€ä»¥ä»¤ç‰Œæ¡¶ç®—æ³•å¯ä»¥æ”¯æŒçªå‘æµé‡ã€‚åŒæ—¶ç”±äºå¾€æœ¨æ¡¶æ·»åŠ ä»¤ç‰Œçš„é€Ÿåº¦æ˜¯å›ºå®šçš„ï¼Œä¸”æœ¨æ¡¶çš„å®¹é‡æœ‰ä¸Šé™ï¼Œæ‰€ä»¥å•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚æ•°ä¹Ÿèƒ½å¤Ÿå¾—åˆ°æ§åˆ¶ï¼Œèµ·åˆ°é™æµçš„ç›®çš„ã€‚å‡è®¾åŠ å…¥ä»¤ç‰Œçš„é€Ÿåº¦ä¸º 1 token/10msï¼Œæ¡¶çš„å®¹é‡ä¸º500ï¼Œåœ¨è¯·æ±‚æ¯”è¾ƒå°‘çš„æ—¶å€™ï¼ˆå°äºæ¯10æ¯«ç§’1ä¸ªè¯·æ±‚ï¼‰æ—¶ï¼Œæœ¨æ¡¶å¯ä»¥å…ˆ&quot;æ”’&quot;ä¸€äº›ä»¤ç‰Œï¼ˆæœ€å¤š500ä¸ªï¼‰ã€‚å½“æœ‰çªå‘æµé‡æ—¶ï¼Œä¸€ä¸‹æŠŠæœ¨æ¡¶å†…çš„ä»¤ç‰Œå–ç©ºï¼Œä¹Ÿå°±æ˜¯æœ‰500ä¸ªåœ¨å¹¶å‘æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ï¼Œä¹‹åè¦ç­‰æ¯10msè¡¥å……ä¸€ä¸ªæ–°çš„ä»¤ç‰Œæ‰èƒ½æ¥æ”¶ä¸€ä¸ªæ–°çš„è¯·æ±‚ã€‚</p>
<p><strong>ä»¤ç‰Œæ¡¶åœ¨æ¥æ”¶è¯·æ±‚é€Ÿåº¦ä¸Šè¿›è¡Œé™åˆ¶ï¼Œæ¼æ¡¶åœ¨å¤„ç†è¯·æ±‚é€Ÿåº¦ä¸Šè¿›è¡Œé™åˆ¶ã€‚</strong></p>
<h4 id="å‚æ•°è®¾ç½®">å‚æ•°è®¾ç½®</h4>
<ul>
<li><strong>æœ¨æ¡¶çš„å®¹é‡</strong> - è€ƒè™‘ä¸šåŠ¡é€»è¾‘çš„èµ„æºæ¶ˆè€—å’Œæœºå™¨èƒ½æ‰¿è½½å¹¶å‘å¤„ç†å¤šå°‘ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li><strong>ç”Ÿæˆä»¤ç‰Œçš„é€Ÿåº¦</strong> - å¤ªæ…¢çš„è¯èµ·ä¸åˆ°â€œæ”’â€ä»¤ç‰Œåº”å¯¹çªå‘æµé‡çš„æ•ˆæœã€‚</li>
</ul>
<h4 id="é€‚ç”¨åœºæ™¯-3">é€‚ç”¨åœºæ™¯</h4>
<p>é€‚åˆç”µå•†æŠ¢è´­æˆ–è€…å¾®åšå‡ºç°çƒ­ç‚¹äº‹ä»¶è¿™ç§åœºæ™¯ï¼Œå› ä¸ºåœ¨é™æµçš„åŒæ—¶å¯ä»¥åº”å¯¹ä¸€å®šçš„çªå‘æµé‡ã€‚å¦‚æœé‡‡ç”¨å‡åŒ€é€Ÿåº¦å¤„ç†è¯·æ±‚çš„ç®—æ³•ï¼Œåœ¨å‘ç”Ÿçƒ­ç‚¹äº‹ä»¶çš„æ—¶å€™ï¼Œä¼šé€ æˆå¤§é‡çš„ç”¨æˆ·æ— æ³•è®¿é—®ï¼Œå¯¹ç”¨æˆ·ä½“éªŒçš„æŸå®³æ¯”è¾ƒå¤§ã€‚</p>
<h3 id="goè¯­è¨€å®ç°-3">Goè¯­è¨€å®ç°</h3>
<p>å‡è®¾æ¯100msç”Ÿäº§ä¸€ä¸ªä»¤ç‰Œï¼ŒæŒ‰ user_id/IP è®°å½•è®¿é—®æœ€è¿‘ä¸€æ¬¡è®¿é—®çš„æ—¶é—´æˆ³ t_last å’Œä»¤ç‰Œæ•°ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶å¦‚æœ now - last &gt; 100ms, å¢åŠ  (now - last) / 100ms ä¸ªä»¤ç‰Œã€‚ç„¶åï¼Œå¦‚æœä»¤ç‰Œæ•° &gt; 0ï¼Œä»¤ç‰Œæ•° -1 ç»§ç»­æ‰§è¡Œåç»­çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¦åˆ™è¿”å›è¯·æ±‚é¢‘ç‡è¶…é™çš„é”™è¯¯ç æˆ–é¡µé¢ã€‚</p>
<pre><code class="language-go">package main

import (
        &quot;fmt&quot;
        &quot;sync&quot;
        &quot;time&quot;
)

// å¹¶å‘è®¿é—®åŒä¸€ä¸ª user_id/ip çš„è®°å½•éœ€è¦ä¸Šé”
var recordMu map[string]*sync.RWMutex

func init() {
        recordMu = make(map[string]*sync.RWMutex)
}

func max(a, b int) int {
        if a &gt; b {
                return a
        }
        return b
}

type TokenBucket struct {
        BucketSize int // æœ¨æ¡¶å†…çš„å®¹é‡ï¼šæœ€å¤šå¯ä»¥å­˜æ”¾å¤šå°‘ä¸ªä»¤ç‰Œ
        TokenRate  time.Duration // å¤šé•¿æ—¶é—´ç”Ÿæˆä¸€ä¸ªä»¤ç‰Œ
        records    map[string]*record // è®°å½• user_id/ip çš„è®¿é—®è®°å½•
}

// ä¸Šæ¬¡è®¿é—®æ—¶çš„æ—¶é—´æˆ³å’Œä»¤ç‰Œæ•°
type record struct {
        last  time.Time
        token int
}

func NewTokenBucket(bucketSize int, tokenRate time.Duration) *TokenBucket {
        return &amp;TokenBucket{
                BucketSize: bucketSize,
                TokenRate:  tokenRate,
                records:    make(map[string]*record),
        }
}

func (t *TokenBucket) getUidOrIp() string {
        // è·å–è¯·æ±‚ç”¨æˆ·çš„ user_id æˆ–è€… ip åœ°å€
        return &quot;127.0.0.1&quot;
}

// è·å–è¿™ä¸ª user_id/ip ä¸Šæ¬¡è®¿é—®æ—¶çš„æ—¶é—´æˆ³å’Œä»¤ç‰Œæ•°
func (t *TokenBucket) getRecord(uidOrIp string) *record {
        if r, ok := t.records[uidOrIp]; ok {
                return r
        }
        return &amp;record{}
}

// ä¿å­˜ user_id/ip æœ€è¿‘ä¸€æ¬¡è¯·æ±‚æ—¶çš„æ—¶é—´æˆ³å’Œä»¤ç‰Œæ•°é‡
func (t *TokenBucket) storeRecord(uidOrIp string, r *record) {
        t.records[uidOrIp] = r
}

// éªŒè¯æ˜¯å¦èƒ½è·å–ä¸€ä¸ªä»¤ç‰Œ
func (t *TokenBucket) validate(uidOrIp string) bool {
        // å¹¶å‘ä¿®æ”¹åŒä¸€ä¸ªç”¨æˆ·çš„è®°å½•ä¸Šå†™é”
        rl, ok := recordMu[uidOrIp]
        if !ok {
                var mu sync.RWMutex
                rl = &amp;mu
                recordMu[uidOrIp] = rl
        }
        rl.Lock()
        defer rl.Unlock()

        r := t.getRecord(uidOrIp)
        now := time.Now()
        if r.last.IsZero() {
                // ç¬¬ä¸€æ¬¡è®¿é—®åˆå§‹åŒ–ä¸ºæœ€å¤§ä»¤ç‰Œæ•°
                r.last, r.token = now, t.BucketSize
        } else {
                if r.last.Add(t.TokenRate).Before(now) {
                        // å¦‚æœä¸ä¸Šæ¬¡è¯·æ±‚çš„é—´éš”è¶…è¿‡äº† token rate
                        // åˆ™å¢åŠ ä»¤ç‰Œï¼Œæ›´æ–° last
                        r.token += max(int(now.Sub(r.last)/t.TokenRate), t.BucketSize)
                        r.last = now
                }
        }
        var result bool
        if r.token &gt; 0 {
                // å¦‚æœä»¤ç‰Œæ•°å¤§äº1ï¼Œå–èµ°ä¸€ä¸ªä»¤ç‰Œï¼Œvalidate ç»“æœä¸º true
                r.token--
                result = true
        }

        // ä¿å­˜æœ€æ–°çš„ record
        t.storeRecord(uidOrIp, r)
        return result
}

// è¿”å›æ˜¯å¦è¢«é™æµ
func (t *TokenBucket) IsLimited() bool {
        return !t.validate(t.getUidOrIp())
}

func main() {
        tokenBucket := NewTokenBucket(5, 100*time.Millisecond)
        for i := 0; i &lt; 6; i++ {
                fmt.Println(tokenBucket.IsLimited())
        }
        time.Sleep(100 * time.Millisecond)
        fmt.Println(tokenBucket.IsLimited())
}
</code></pre>
<h3 id="å¸¸è§è°ƒåŒ…ä½¿ç”¨-2">å¸¸è§è°ƒåŒ…ä½¿ç”¨</h3>
<ul>
<li><strong>golang.org/x/time/rate</strong></li>
</ul>
<h3 id="5-è‡ªé€‚åº”é™æµ">5. è‡ªé€‚åº”é™æµ</h3>
<p>æ¼æ¡¶å’Œä»¤ç‰Œæ¡¶éƒ½ä¼šæœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯éœ€è¦æå‰è®¾ç½®é˜€å€¼ï¼Œä½†æ˜¯é˜€å€¼æ€ä¹ˆè®¾å®šï¼Œæ˜¯å¦åˆç†æ˜¯ä¸ªé—®é¢˜ã€‚ä¸€èˆ¬æˆ‘ä»¬éœ€è¦å‹æµ‹æ¥è®¾å®šï¼Œä½†æ˜¯å·¥ä½œé‡å¾ˆå¤§ï¼Œè€Œä¸”ä¸èƒ½åŠ¨æ€å˜åŒ–ã€‚</p>
<p>æœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡è·å–çº¿ä¸Šä¸šåŠ¡åŠ¨æ€å˜åŒ–æ¥æ›´æ–°é™æµç­–ç•¥ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°æ®æ¥åšå¯å‘é˜ˆå€¼ï¼Œåªè¦è¿™ä¸ªæŒ‡æ ‡è¾¾åˆ°äº†é˜ˆå€¼é‚£æˆ‘ä»¬å°±è¿›å…¥æµæ§å½“ä¸­ã€‚å¸¸è§çš„é€‰æ‹©ä¸€èˆ¬æ˜¯ CPUã€Memoryã€System Loadï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥ CPU ä¸ºä¾‹ã€‚</p>
<p>åªè¦æˆ‘ä»¬çš„ CPU è´Ÿè½½è¶…è¿‡ 80% çš„æ—¶å€™ï¼Œè·å–è¿‡å» 5s çš„æœ€å¤§ååæ•°æ®ï¼Œç„¶åå†ç»Ÿè®¡å½“å‰ç³»ç»Ÿä¸­çš„è¯·æ±‚æ•°é‡ï¼Œåªè¦å½“å‰ç³»ç»Ÿä¸­çš„è¯·æ±‚æ•°å¤§äºæœ€å¤§ååé‚£ä¹ˆæˆ‘ä»¬å°±ä¸¢å¼ƒè¿™ä¸ªè¯·æ±‚ã€‚</p>
<h3 id="sentinelalibaba">Sentinelï¼ˆAlibabaï¼‰</h3>
<p>éšç€å¾®æœåŠ¡çš„æµè¡Œï¼ŒæœåŠ¡å’ŒæœåŠ¡ä¹‹é—´çš„ç¨³å®šæ€§å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚Sentinel æ˜¯é¢å‘åˆ†å¸ƒå¼æœåŠ¡æ¶æ„çš„æµé‡æ§åˆ¶ç»„ä»¶ï¼Œä¸»è¦ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦æ¥å¸®åŠ©æ‚¨ä¿éšœå¾®æœåŠ¡çš„ç¨³å®šæ€§ã€‚</p>
<h4 id="sentinelä½¿ç”¨æ–‡æ¡£">Sentinelä½¿ç”¨æ–‡æ¡£</h4>
<p>ç”¨æˆ·æ¥å…¥ä½¿ç”¨ Sentinel Go ä¸»è¦éœ€è¦ä»¥ä¸‹å‡ æ­¥ï¼š</p>
<ol>
<li>å¯¹ Sentinel çš„è¿è¡Œç¯å¢ƒè¿›è¡Œç›¸å…³é…ç½®å¹¶åˆå§‹åŒ–ã€‚API æ¥å£ä½¿ç”¨ç»†èŠ‚å¯ä»¥å‚è€ƒï¼šé…ç½®æ–¹å¼ã€‚</li>
<li>åŸ‹ç‚¹ï¼ˆå®šä¹‰èµ„æºï¼‰ï¼Œè¯¥æ­¥éª¤ä¸»è¦æ˜¯ç¡®å®šç³»ç»Ÿä¸­æœ‰å“ªäº›èµ„æºéœ€è¦é˜²æŠ¤ï¼Œèµ„æºå®šä¹‰å¯å‚è€ƒï¼šæ–°æ‰‹æŒ‡å—ã€‚</li>
<li>é…ç½®è§„åˆ™ï¼Œè¯¥æ­¥éª¤ä¸»è¦æ˜¯ä¸ºæ¯ä¸ªèµ„æºéƒ½é…ç½®å…·ä½“çš„è§„åˆ™ï¼Œè§„åˆ™çš„é…ç½®å¯å‚è€ƒï¼šæ–°æ‰‹æŒ‡å— ä»¥åŠå„ä¸ªæ¨¡å—çš„ä½¿ç”¨æ–‡æ¡£ã€‚</li>
<li>ç¼–å†™èµ„æºé˜²æŠ¤çš„å…¥å£å’Œå‡ºå£ä»£ç ã€‚é‡Šæ”¾æ–¹å¼å¯å‚è€ƒï¼šæ–°æ‰‹æŒ‡å—ã€‚</li>
</ol>
<p>é’ˆå¯¹åŸ‹ç‚¹èµ„æºé…ç½®ç›¸åº”çš„è§„åˆ™ï¼Œæ¥è¾¾åˆ°æµé‡æ§åˆ¶çš„æ•ˆæœã€‚ç›®å‰ Sentinel æ”¯æŒäº”ç§è§„åˆ™ï¼š</p>
<ul>
<li>æµæ§è§„åˆ™</li>
<li>æµé‡éš”ç¦»è§„åˆ™</li>
<li>ç†”æ–­è§„åˆ™</li>
<li>è‡ªé€‚åº”æµæ§è§„åˆ™</li>
<li>çƒ­ç‚¹å‚æ•°æµæ§è§„åˆ™</li>
</ul>
<h3 id="ä¸€ä¸ªç®€å•çš„ä¾‹å­sentinel-go-æ¥å…¥-demo">ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šSentinel Go æ¥å…¥ demo</h3>
<pre><code class="language-go">import (
        sentinel &quot;github.com/alibaba/sentinel-golang/api&quot;
)

func main() {
        // ç¬¬ä¸€æ­¥ï¼šåŠ¡å¿…å…ˆè¿›è¡Œåˆå§‹åŒ–
        err := sentinel.InitDefault()
        if err != nil {
                log.Fatal(err)
        }

        // ç¬¬ä¸‰æ­¥ï¼šä¸ºæ¯ä¸ªèµ„æºé…ç½®é™æµè§„åˆ™
        _, err = flow.LoadRules([]*flow.Rule{
                {
                        Resource:               &quot;some-test&quot;,
                        Threshold:              10,
                        TokenCalculateStrategy: flow.Direct,
                        ControlBehavior:        flow.Reject,
                },
        })
        if err != nil {
                fmt.Println(err)
                return
        }

        ch := make(chan struct{})
        for i := 0; i &lt; 10; i++ {
                go func() {
                        for {
                                // ç¬¬äºŒæ­¥ï¼šåŸ‹ç‚¹é€»è¾‘ï¼ŒåŸ‹ç‚¹èµ„æºåä¸º some-test
                                e, b := sentinel.Entry(&quot;some-test&quot;)
                                if b != nil {
                                        // è¾¾åˆ°é™æµï¼šè¯·æ±‚è¢«æ‹’ç»ï¼Œåœ¨æ­¤å¤„è¿›è¡Œå¤„ç†
                                        time.Sleep(time.Duration(rand.Uint64()%10) * time.Millisecond)
                                } else {
                                        // ä¸ºè¾¾åˆ°é™æµï¼šè¯·æ±‚å…è®¸é€šè¿‡ï¼Œæ­¤å¤„ç¼–å†™ä¸šåŠ¡é€»è¾‘
                                        fmt.Println(util.CurrentTimeMillis(), &quot;Passed&quot;)
                                        time.Sleep(time.Duration(rand.Uint64()%10) * time.Millisecond)

                                        // åŠ¡å¿…ä¿è¯ä¸šåŠ¡ç»“æŸåè°ƒç”¨ Exit
                                        e.Exit()
                                }
                        }
                }()
        }
        &lt;-ch
}
</code></pre>
<h3 id="è‡ªé€‚åº”æµæ§è§„åˆ™">è‡ªé€‚åº”æµæ§è§„åˆ™</h3>
<p><strong>rule å­—æ®µ</strong>ï¼š</p>
<pre><code class="language-go">// Rule describes the policy for system resiliency.
type Rule struct {
        // ID represents the unique ID of the rule (optional).
        ID string `json:&quot;id,omitempty&quot;`
        // MetricType indicates the type of the trigger metric.
        MetricType MetricType `json:&quot;metricType&quot;`
        // TriggerCount represents the lower bound trigger of the adaptive strategy.
        // Adaptive strategies will not be activated until target metric has reached the trigger count.
        TriggerCount float64 `json:&quot;triggerCount&quot;`
        // Strategy represents the adaptive strategy.
        Strategy AdaptiveStrategy `json:&quot;strategy
        // MetricType indicates the type of the trigger metric.
        MetricType MetricType `json:&quot;metricType&quot;`
        // Threshold represents the threshold value for the rule.
        Threshold float64 `json:&quot;threshold&quot;`
        // ControlBehavior defines the behavior when the threshold is exceeded.
        ControlBehavior ControlBehavior `json:&quot;controlBehavior&quot;`
        // Count represents the count of requests to trigger the rule.
        Count int `json:&quot;count,omitempty&quot;`
        // Duration defines the time window for the rule.
        Duration time.Duration `json:&quot;duration,omitempty&quot;`
}
</code></pre>
<h3 id="è‡ªé€‚åº”æµæ§ç¤ºä¾‹">è‡ªé€‚åº”æµæ§ç¤ºä¾‹</h3>
<p>è‡ªé€‚åº”æµæ§è§„åˆ™å¯ä»¥æ ¹æ®ç³»ç»Ÿçš„å®æ—¶è´Ÿè½½åŠ¨æ€è°ƒæ•´é™æµé˜ˆå€¼ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ Sentinel çš„è‡ªé€‚åº”æµæ§åŠŸèƒ½ï¼š</p>
<pre><code class="language-go">import (
        &quot;github.com/alibaba/sentinel-golang/api&quot;
        &quot;github.com/alibaba/sentinel-golang/core/flow&quot;
)

func main() {
        // åˆå§‹åŒ– Sentinel
        err := sentinel.InitDefault()
        if err != nil {
                log.Fatal(err)
        }

        // é…ç½®è‡ªé€‚åº”æµæ§è§„åˆ™
        _, err = flow.LoadRules([]*flow.Rule{
                {
                        Resource:               &quot;adaptive-resource&quot;,
                        Threshold:              100,
                        ControlBehavior:        flow.SmoothBreach,
                        MetricType:            flow.QPS,
                        Count:                  10,
                        Duration:               10 * time.Second,
                },
        })
        if err != nil {
                log.Fatal(err)
        }

        // æ¨¡æ‹Ÿè¯·æ±‚
        for i := 0; i &lt; 200; i++ {
                go func() {
                        e, b := sentinel.Entry(&quot;adaptive-resource&quot;)
                        if b != nil {
                                // è¾¾åˆ°é™æµï¼Œå¤„ç†æ‹’ç»é€»è¾‘
                                fmt.Println(&quot;Request rejected&quot;)
                        } else {
                                // å¤„ç†è¯·æ±‚
                                fmt.Println(&quot;Request passed&quot;)
                                e.Exit()
                        }
                }()
        }
        time.Sleep(5 * time.Second)
}
</code></pre>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>é€šè¿‡ä»¥ä¸Šçš„å†…å®¹ï¼Œæˆ‘ä»¬æ·±å…¥æ¢è®¨äº†ç³»ç»Ÿå®¹é”™çš„å‡ ç§å¸¸è§ç­–ç•¥ï¼ŒåŒ…æ‹¬ç†”æ–­ã€é™æµå’ŒæœåŠ¡é™çº§ã€‚æ¯ç§ç­–ç•¥éƒ½æœ‰å…¶ç‹¬ç‰¹çš„å®ç°æ–¹å¼å’Œé€‚ç”¨åœºæ™¯ã€‚æ ¹æ®ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚å’Œç³»ç»Ÿæ¶æ„ï¼Œé€‰æ‹©åˆé€‚çš„å®¹é”™æœºåˆ¶èƒ½å¤Ÿæœ‰æ•ˆæå‡ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§ã€‚</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%89%8D%E8%A8%80">å‰è¨€</a></li>
<li><a href="#%E6%A6%82%E8%BF%B0">æ¦‚è¿°</a>
<ul>
<li><a href="#1-%E7%86%94%E6%96%AD%E5%AE%A2%E6%88%B7%E7%AB%AF">1. ç†”æ–­ï¼ˆå®¢æˆ·ç«¯ï¼‰</a>
<ul>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%86%94%E6%96%AD">ä¸ºä»€ä¹ˆè¦ç†”æ–­ï¼Ÿ</a></li>
</ul>
</li>
<li><a href="#2-%E9%99%90%E6%B5%81%E6%9C%8D%E5%8A%A1%E7%AB%AF">2. é™æµï¼ˆæœåŠ¡ç«¯ï¼‰</a>
<ul>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E9%99%90%E6%B5%81">ä¸ºä»€ä¹ˆè¦é™æµï¼Ÿ</a></li>
</ul>
</li>
<li><a href="#3-%E9%99%8D%E7%BA%A7">3. é™çº§</a>
<ul>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E9%99%8D%E7%BA%A7">ä¸ºä»€ä¹ˆè¦é™çº§ï¼Ÿ</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E7%86%94%E6%96%AD">ç†”æ–­</a></li>
<li><a href="#%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94">æ–¹æ¡ˆå¯¹æ¯”</a>
<ul>
<li><a href="#hystrix-go">Hystrix-Go</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">ä½¿ç”¨æ–¹æ³•ï¼š</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E5%90%AB%E4%B9%89">é…ç½®å‚æ•°å«ä¹‰ï¼š</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0">æ ¸å¿ƒå®ç°</a></li>
</ul>
</li>
<li><a href="#google-sre%E4%BF%9D%E6%8A%A4%E7%AE%97%E6%B3%95">Google SREä¿æŠ¤ç®—æ³•</a>
<ul>
<li><a href="#kratos%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">Kratosæºç åˆ†æ</a></li>
</ul>
</li>
<li><a href="#%E7%86%94%E6%96%AD%E4%B8%8E-failover-%E7%BB%93%E5%90%88%E7%9A%84%E6%80%9D%E6%83%B3">ç†”æ–­ä¸ Failover ç»“åˆçš„æ€æƒ³</a></li>
<li><a href="#%E9%99%90%E6%B5%81">é™æµ</a>
<ul>
<li><a href="#1-%E5%9B%BA%E5%AE%9A%E7%AA%97%E5%8F%A3">1. å›ºå®šçª—å£</a></li>
<li><a href="#2-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3">2. æ»‘åŠ¨çª—å£</a>
<ul>
<li><a href="#%E7%AE%97%E6%B3%95%E6%80%9D%E6%83%B3">ç®—æ³•æ€æƒ³</a></li>
<li><a href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF">é€‚ç”¨åœºæ™¯</a></li>
</ul>
</li>
<li><a href="#go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0">Goè¯­è¨€å®ç°</a></li>
<li><a href="#3-%E6%BC%8F%E6%A1%B6">3. æ¼æ¡¶</a>
<ul>
<li><a href="#%E7%AE%97%E6%B3%95%E6%80%9D%E6%83%B3-2">ç®—æ³•æ€æƒ³</a></li>
<li><a href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF-2">é€‚ç”¨åœºæ™¯</a></li>
</ul>
</li>
<li><a href="#go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0-2">Goè¯­è¨€å®ç°</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E8%B0%83%E5%8C%85%E4%BD%BF%E7%94%A8">å¸¸è§è°ƒåŒ…ä½¿ç”¨</a></li>
<li><a href="#4-%E4%BB%A4%E7%89%8C%E6%A1%B6">4. ä»¤ç‰Œæ¡¶</a>
<ul>
<li><a href="#%E7%AE%97%E6%B3%95%E6%80%9D%E6%83%B3-3">ç®—æ³•æ€æƒ³</a></li>
<li><a href="#%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE">å‚æ•°è®¾ç½®</a></li>
<li><a href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF-3">é€‚ç”¨åœºæ™¯</a></li>
</ul>
</li>
<li><a href="#go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0-3">Goè¯­è¨€å®ç°</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E8%B0%83%E5%8C%85%E4%BD%BF%E7%94%A8-2">å¸¸è§è°ƒåŒ…ä½¿ç”¨</a></li>
<li><a href="#5-%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81">5. è‡ªé€‚åº”é™æµ</a></li>
<li><a href="#sentinelalibaba">Sentinelï¼ˆAlibabaï¼‰</a>
<ul>
<li><a href="#sentinel%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3">Sentinelä½¿ç”¨æ–‡æ¡£</a></li>
</ul>
</li>
<li><a href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90sentinel-go-%E6%8E%A5%E5%85%A5-demo">ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šSentinel Go æ¥å…¥ demo</a></li>
<li><a href="#%E8%87%AA%E9%80%82%E5%BA%94%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99">è‡ªé€‚åº”æµæ§è§„åˆ™</a></li>
<li><a href="#%E8%87%AA%E9%80%82%E5%BA%94%E6%B5%81%E6%8E%A7%E7%A4%BA%E4%BE%8B">è‡ªé€‚åº”æµæ§ç¤ºä¾‹</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://mzhtech.github.io/post/ye-wu-kai-fa-ri-chang-gong-zuo-de-fang-fa-lun/">
              <h3 class="post-title">
                ä¸šåŠ¡å¼€å‘æ—¥å¸¸å·¥ä½œçš„æ–¹æ³•è®º
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  
  <a class="rss" href="https://mzhtech.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
